---
title: "Ikos_EDA"
author: "Jenny Zhu"
date: "9/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(data.table)
library(openxlsx)
library(rjson)
library(jsonlite)
library(rlist)
library(gridExtra)
library(HH)
library(caret)
library(data.table)
library(openxlsx)
library(jsonlite)
library(rlist)
library(car)
library(ggbeeswarm)
library(randomForest)
library(zipcode)
library(ggmap)
library(plyr)
```


# Loading properties.json
```{r}
# rename columns of property_events
events = read_csv("data/kpi.properties.star.csv")
# colnames(events)
len = length(colnames(events))
for (i in 1:4){
  len_name = nchar(colnames(events)[i])
  colnames(events)[i] = substr(colnames(events)[i], 2, len_name)
}
# colnames(events)
for (j in c(5:ncol(events))){
  len_name = nchar(colnames(events)[j])
  colnames(events)[j] = substr(colnames(events)[j], 9, len_name)
}

for (k in c(31,32)){
  len_name = nchar(colnames(events)[k])
  colnames(events)[k] = substr(colnames(events)[k], 2, len_name)
}
print(colnames(events))
events$timestamp = as.character(events$timestamp)
# replace all hyphens with NA
events[events == "-"] <- NA
```

# Creating Time to rent and lastest_rent column
```{r}
event_all_df <- events
event_all_df$rent = as.numeric(event_all_df$rent)
#5201 unique property id in event_all_df
length(unique(event_all_df$property_id))

event_all_df <- subset(event_all_df, region_name == 'pittsburgh_pa')
event_all_df <- transform(event_all_df, property_id = as.integer(property_id), timestamp = as.Date(strptime(gsub('T',' ',as.character(timestamp)), format="%Y-%m-%d")), rent = as.numeric(rent))
event_rented_df <- subset(event_all_df, status == 'Rented' | status == 'Archived')
rented_ids <- na.omit(unique(event_rented_df$property_id))
length(rented_ids)
event_active_df <- subset(event_all_df, status == 'Active' & property_id %in% rented_ids)
event_rented_all_df <- subset(event_all_df, property_id %in% event_active_df$property_id)

event_rented_grouped_df <- event_rented_df %>% group_by(property_id) %>% arrange(timestamp) %>% mutate(made_rented_date = max(timestamp), latest_rent = last(rent)) %>% select(property_id, made_rented_date, latest_rent)
event_active_grouped_df <- event_active_df %>% select(property_id, status, timestamp) %>% group_by(property_id) %>% arrange(timestamp) %>% mutate(first_active_date = min(timestamp), last_active_date = max(timestamp)) %>% select(property_id, first_active_date, last_active_date)
head(event_rented_grouped_df)
head(event_active_grouped_df)
# strip out negative and 0 and 1 for days to rent
event_ttr_df <- merge(event_active_grouped_df, event_rented_grouped_df, by='property_id') %>% group_by(property_id) %>% summarize(time_to_rent = made_rented_date[1] - last_active_date[1], latest_rent = last(latest_rent)) %>% filter(., time_to_rent > 1)
event_ttr_df
```

```{r}
# adding time to rent and lastest rent to property attributes table -- rented property
properties_table$id = as.numeric(properties_table$id)
properties_ttr_table <- event_ttr_df %>% left_join(properties_table, by = c('property_id'='id'))
```

## Data frame preprocessing properties_ttr_table
```{r}
# convert time to rent (diff_days) to numeric values
properties_ttr_table$time_to_rent = as.numeric(properties_ttr_table$time_to_rent)

# replace N and empty string with NA values
properties_ttr_table[properties_ttr_table == "\"N"|properties_ttr_table == '""'] <- NA

# convert time columns to date
properties_ttr_table$availability_date = 
  as.Date(substr(properties_ttr_table$availability_date, 2,11))
properties_ttr_table$created_date = 
  as.Date(substr(properties_ttr_table$created_date, 2,11))
properties_ttr_table$last_modified = 
  as.Date(substr(properties_ttr_table$last_modified, 2,11))

# convert a column of strings to a column of numbers
str_to_num = function(x){
  return(as.numeric(gsub("[^0-9.]","", x)))
}

# clean columns of strings
properties_ttr_table$rent = str_to_num(properties_ttr_table$rent)
properties_ttr_table$deposit = str_to_num(properties_ttr_table$deposit)
properties_ttr_table$square_feet = str_to_num(properties_ttr_table$square_feet)
properties_ttr_table$bedrooms = str_to_num(properties_ttr_table$bedrooms)
properties_ttr_table$neighborhood_id = as.factor(str_to_num(properties_ttr_table$neighborhood_id))
properties_ttr_table$zip = as.factor(str_to_num(properties_ttr_table$zip))
properties_ttr_table$type = as.factor(gsub("[^a-zA-z.]","", properties_ttr_table$type))
properties_ttr_table$parking = as.factor(gsub("[^a-zA-z.]","", properties_ttr_table$parking))
properties_ttr_table$pet_deposit = str_to_num(properties_ttr_table$pet_deposit)
properties_ttr_table$pet_rent = str_to_num(properties_ttr_table$pet_rent)
properties_ttr_table$status = as.factor(gsub("[^a-zA-z.]","", properties_ttr_table$status))
properties_ttr_table$application_fee = str_to_num(properties_ttr_table$application_fee)
properties_ttr_table$heat_source = as.factor(gsub("[^a-zA-z.]","", properties_ttr_table$heat_source))
properties_ttr_table$longitude = str_to_num(properties_ttr_table$longitude)
properties_ttr_table$latitude = str_to_num(properties_ttr_table$latitude)
properties_ttr_table$building_id = str_to_num(properties_ttr_table$building_id)
properties_ttr_table$address = gsub("[^a-zA-z 0-9.]","", properties_ttr_table$address)
properties_ttr_table$address2 = gsub("[^a-zA-z 0-9.]","", properties_ttr_table$address2)
properties_ttr_table$display_name = gsub("[^a-zA-z 0-9.]","", properties_ttr_table$display_name)
properties_ttr_table$city = gsub("[^a-zA-z.]","", properties_ttr_table$city)
properties_ttr_table$state = gsub("[^a-zA-z.]","", properties_ttr_table$state)
properties_ttr_table$region_id = str_to_num(properties_ttr_table$region_id)
properties_ttr_table$assignee_id = str_to_num(properties_ttr_table$assignee_id)
properties_ttr_table$organization_id = str_to_num(properties_ttr_table$organization_id)
properties_ttr_table$full_bathrooms = str_to_num(properties_ttr_table$full_bathrooms)
properties_ttr_table$half_bathrooms = str_to_num(properties_ttr_table$half_bathrooms)

str_to_factor = function(x){
    x = gsub("[^0-9.]","", x)
    x = gsub("0","No", x)
    x = gsub("1","Yes", x)
    x = as.factor(x)
  return (x)
}
properties_ttr_table$disability_access = str_to_factor(properties_ttr_table$disability_access)
properties_ttr_table$washer_dryer = str_to_factor(properties_ttr_table$washer_dryer)
properties_ttr_table$washer_dryer_hookups = str_to_factor(properties_ttr_table$washer_dryer_hookups)
properties_ttr_table$dish_washer= str_to_factor(properties_ttr_table$dish_washer)
properties_ttr_table$air_conditioning= str_to_factor(properties_ttr_table$air_conditioning)
properties_ttr_table$section_8= str_to_factor(properties_ttr_table$section_8)
properties_ttr_table$cats= str_to_factor(properties_ttr_table$cats)
properties_ttr_table$small_dogs= str_to_factor(properties_ttr_table$small_dogs)
properties_ttr_table$large_dogs= str_to_factor(properties_ttr_table$large_dogs)
properties_ttr_table$dog_breed_restrictions= str_to_factor(properties_ttr_table$dog_breed_restrictions)
properties_ttr_table$other_pets= str_to_factor(properties_ttr_table$other_pets)
properties_ttr_table$elevator= str_to_factor(properties_ttr_table$elevator)
properties_ttr_table$accessible_bathroom = str_to_factor(properties_ttr_table$accessible_bathroom)
properties_ttr_table$ramp = str_to_factor(properties_ttr_table$ramp)

stf_facility = function(x){
    x = gsub("[^0-9.]","", x)
    x = gsub("0","included", x)
    x = gsub("1","not included", x)
    x = as.factor(x)
  return (x)
}
properties_ttr_table$water= stf_facility(properties_ttr_table$water)
properties_ttr_table$sewage= stf_facility(properties_ttr_table$sewage)
properties_ttr_table$garbage= stf_facility(properties_ttr_table$garbage)
properties_ttr_table$electricity= stf_facility(properties_ttr_table$electricity)
properties_ttr_table$gas= stf_facility(properties_ttr_table$gas)
properties_ttr_table$internet= stf_facility(properties_ttr_table$internet)
properties_ttr_table$cable= stf_facility(properties_ttr_table$cable)
properties_ttr_table$longitude = -properties_ttr_table$longitude
properties_ttr_table$heat_source = as.factor(properties_ttr_table$heat_source)

# convert NA in pet deposit, pet rent to 0
properties_ttr_table[is.na(properties_ttr_table$pet_rent), "pet_rent"] = 0
properties_ttr_table[is.na(properties_ttr_table$pet_deposit), "pet_deposit"] = 0


# all rented properties have equivalent rent and latest rent
sum(properties_ttr_table$rent != properties_ttr_table$latest_rent)
properties_ttr_table$latest_rent = NULL

properties_ttr_table$status = NULL

# creating a single column for pets
pets = vector(length = nrow(properties_ttr_table))
for (i in 1: nrow(properties_ttr_table)){
    pets[i] = paste("Cats", as.character(properties_ttr_table$cats[i] == "Yes"), "Smalldogs",as.character(properties_ttr_table$small_dogs[i] == "Yes"), "Largedogs",as.character(properties_ttr_table$large_dogs[i] == "Yes"),
"Otherpets", as.character(properties_ttr_table$other_pets[i] == "Yes"), sep = "")
}
properties_ttr_table$pets = as.factor(pets)
properties_ttr_table <- properties_ttr_table %>% mutate(
  pets = fct_recode(factor(pets),
                        "no pets" = "CatsFALSESmalldogsFALSELargedogsFALSEOtherpetsFALSE",
                        "cats and small dogs" = "CatsTRUESmalldogsTRUELargedogsFALSEOtherpetsFALSE",
                        "cats and dogs" = "CatsTRUESmalldogsTRUELargedogsTRUEOtherpetsFALSE",
                        "except large dogs" = "CatsTRUESmalldogsTRUELargedogsFALSEOtherpetsTRUE",
                        "small dogs" = "CatsFALSESmalldogsTRUELargedogsFALSEOtherpetsFALSE",
                        "dogs" = "CatsFALSESmalldogsTRUELargedogsTRUEOtherpetsFALSE",
                        "all pets" = "CatsTRUESmalldogsTRUELargedogsTRUEOtherpetsTRUE",
                        "cats" = "CatsTRUESmalldogsFALSELargedogsFALSEOtherpetsFALSE",
                        "except dogs" = "CatsTRUESmalldogsFALSELargedogsFALSEOtherpetsTRUE",
                        "except cats and dogs" = "CatsFALSESmalldogsFALSELargedogsFALSEOtherpetsTRUE",
                        "cats and large dogs" = "CatsTRUESmalldogsFALSELargedogsTRUEOtherpetsFALSE"))

properties_ttr_table <- properties_ttr_table %>% 
  mutate(pet_rent = replace(pet_rent, pets == "no pets" & pet_rent != 0,0), 
         pet_deposit = replace(pet_deposit, pets == "no pets" & pet_deposit!=0, 0))

properties_ttr_table$zip_mod = properties_ttr_table$zip
# levels(properties_ttr_table$zip_mod)[!levels(properties_ttr_table$zip_mod)%in%c(15203,15213,15211,15217)] = "other"
levels(properties_ttr_table$zip_mod)[!levels(properties_ttr_table$zip_mod)%in%c(15203,15213,15211,15217, 15232,15206,15212)] = "other"
properties_ttr_table$pets_mod = properties_ttr_table$pets
levels(properties_ttr_table$pets_mod)[!levels(properties_ttr_table$pets_mod)%in%c("no pets","cats and dogs","cats and small dogs")] = "other"

feedback_by_property_df = readRDS("data/feedback_by_property_df")
properties_ttr_table <- properties_ttr_table %>% left_join(feedback_by_property_df)
saveRDS(properties_ttr_table, file = "data/properties_ttr_table.rds")
```

# Reading in the cleaned data
```{r}
properties_ttr <- readRDS(file='data/properties_ttr_table.rds') 
```

## 1D plots
```{r, fig.height= 8, fig.width=7}
# EDA -- marginal distribution of variables of interest
my_theme <-  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 8),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        strip.text = element_text(size = 10)) 

Rent <- ggplot(properties_ttr_table, aes(x = rent)) +
  geom_histogram(color = "black",fill = "lightblue", binwidth = 100) +
  labs(title = "Rent",
       x = "Rent ($)",
       y = "# Properties") + 
  scale_x_continuous(breaks=seq(400,1800,100)) +
  my_theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

Time_to_rent <- ggplot(properties_ttr_table, aes(x = time_to_rent)) +
  geom_histogram(color = "black", fill = "lightblue", binwidth = 5) +
  labs(title = "Days to Rent",
       x = "Number of days to rent",
       y = "# Properties")  +
  scale_x_continuous(breaks=seq(-300,400,30)) +
  my_theme +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 

log_ttr <- ggplot(df2, aes(x = log_ttr)) +
  geom_histogram(color = "black", fill = "lightblue", binwidth = 0.5) +
  labs(title = "Log(Days to Rent)",
       x = "Number of days to rent",
       y = "# Properties") +
  my_theme +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 

Disability_access <- ggplot(properties_ttr_table, aes(x = disability_access)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Disability Access",
       x = "Whether the property has disability access",
       y = "# Properties") + 
  my_theme

Type <- ggplot(properties_ttr_table, aes(x = type)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Type",
       x = " Property Type",
       y = " # Properties") + 
  my_theme

Parking <- ggplot(properties_ttr_table, aes(x = parking)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Parking",
       x = " Parking Type",
       y = " # Properties") + 
  my_theme

AC <- ggplot(properties_ttr_table, aes(x = air_conditioning)) +
  geom_bar(fill = "lightblue") +
  labs(title = "AC",
       x = "Whether the property has AC or not",
       y = " # Properties") + 
  my_theme

Bedrooms <- ggplot(properties_ttr_table, aes(x = bedrooms)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Bedrooms",
       x = " # Bedrooms",
       y = " # Properties") + 
  my_theme

Pets <- ggplot(properties_ttr_table, aes(x = pets)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Pets",
       x = " Pet policy",
       y = " # Properties") + 
  my_theme

grid.arrange(Rent, Bedrooms,
             Disability_access, Type, Time_to_rent, 
             Parking, AC, Pets, nrow = 4)
```

## 2D plots
```{r}
# variable relationships with time to rent
rent_ttr <- ggplot(df3, aes(x = rent, y = time_to_rent)) + 
  geom_point()
type_ttr <- ggplot(df3, aes(x = type, y = time_to_rent)) + 
  geom_boxplot()
washerdryer_ttr <-ggplot(df3, aes(x = washer_dryer, y = time_to_rent)) + 
  geom_boxplot()

pets_ttr <- ggplot(df3, aes(x = pets_mod, y = time_to_rent)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 
cluster_ttr <- ggplot(df3, aes(x = cluster, y = time_to_rent)) + 
  geom_boxplot()

bedrooms_ttr <- ggplot(df3, aes(x = bedrooms, y = time_to_rent)) + 
  geom_boxplot()

elevator_ttr <- ggplot(df3, aes(x = elevator, y = time_to_rent)) + 
  geom_boxplot()


```

## 3D plots
```{r}
ggplot(properties_ttr_table, aes(x = rent, y = time_to_rent, col = type)) + 
  geom_point()

ggplot(properties_ttr_table, aes(x = rent, y = time_to_rent, col = washer_dryer)) + 
  geom_point()

ggplot(properties_ttr_table, aes(x = rent, y = time_to_rent, col = bedrooms)) + 
  geom_point()

ggplot(properties_ttr_table, aes(x = rent, y = time_to_rent, col = parking)) + 
  geom_point()

ggplot(properties_ttr_table, aes(x = elevator, y = rent)) + 
  geom_violin()

ggplot(properties_ttr_table, aes(x = air_conditioning, y = rent)) + 
  geom_violin()
ggplot(properties_ttr_table, aes(x = disability_access, y = rent)) + 
  geom_beeswarm(cex = 1.2, size = 0.1)
```


## Multiple regression model with zip_mod
```{r}
df2 <- properties_ttr_table %>%
  mutate(log_ttr = log(time_to_rent)) %>%
  select(.,time_to_rent, log_ttr,rent, zip_mod, type,bedrooms, deposit, parking, washer_dryer, washer_dryer_hookups, dish_washer, air_conditioning, pet_deposit, pet_rent, section_8, pets, dog_breed_restrictions, application_fee, water, sewage, garbage, electricity, gas, full_bathrooms, half_bathrooms, heat_source, elevator, pets_mod, pet_rent,pet_deposit) %>% na.omit()

# only one property has 6 bedrooms, remove
df2 = df2 %>% filter(., bedrooms != 6)

df2$type <- relevel(df2$type, ref="Condo")
fullm2 <-lm(log_ttr ~ rent + zip_mod + type + bedrooms + deposit + parking + washer_dryer +
              washer_dryer_hookups + dish_washer + air_conditioning  + pets_mod + 
              dog_breed_restrictions + application_fee + water + sewage + garbage + electricity +
              gas + full_bathrooms + half_bathrooms +  heat_source + elevator +
              pet_rent + pet_deposit  + rent * washer_dryer + type * pets_mod + type * zip_mod,
              data = df2)
finalmod2 = step(fullm2, direction="both")
summary(finalmod2)
coefficient <- as.data.frame(summary(finalmod2)$coefficients[,c(1,4)])
coefficient$multiplication_factor = exp(coefficient$Estimate)
```

## Multiple regression model diagnostic
```{r}
# check collinearity
vif(finalmod2) 

# cook's distance are all small
cookd = cooks.distance(finalmod2)
sort(pf(cookd,14,825-14),decreasing=TRUE)[1:5]
# model diagnostic plots
plot(finalmod2) 
# check independence between categorical variables
chisq.test(df2$elevator, df2$ramp, correct = FALSE)
chisq.test(df2$elevator, df2$disability_access, correct = FALSE)
chisq.test(df2$ramp, df2$disability_access, correct = FALSE)
```

## Generalized linear model (reponse - poisson distribution)
```{r}
glm_mod <-glm(time_to_rent ~ rent + zip_mod + type + bedrooms + deposit + parking + washer_dryer +
              washer_dryer_hookups + dish_washer + air_conditioning  + pets_mod + 
              dog_breed_restrictions + application_fee + water + sewage + garbage + electricity+
              gas + full_bathrooms + half_bathrooms +  heat_source + elevator + pet_rent + 
              pet_deposit + rent * washer_dryer + type * pets_mod + type * zip_mod, family = poisson, data = df2)
glmmod = step(glm_mod)
summary(glmmod)
plot(glmmod)
cookd_glm = cooks.distance(glmmod)
sort(pf(cookd_glm,25,825-25),decreasing=TRUE)[1:15]
df3 <- df2[-c(823,181,93,384,180,569),]
glm_mod_2 <-glm(time_to_rent ~ rent + zip_mod + type + bedrooms + deposit + parking + washer_dryer +
              washer_dryer_hookups + dish_washer + air_conditioning  + pets_mod + 
              dog_breed_restrictions + application_fee + water + sewage + garbage + electricity + internet + cable+
              gas + full_bathrooms + half_bathrooms +  heat_source + elevator + disability_access + 
              ramp + pet_rent + pet_deposit + rent * washer_dryer + type * pets_mod + type * zip_mod,
              family = poisson, data = df3)
glmmod2 = step(glm_mod_2)
summary(glmmod2)
plot(glmmod2)
cookd_glm2 = cooks.distance(glmmod2)
sort(pf(cookd_glm2,25,817-25),decreasing=TRUE)[1:15]
df4 <- df3[-c(86,303),]
glm_mod_3 <-glm(time_to_rent ~ rent + zip_mod + type + bedrooms + deposit + parking + washer_dryer +
              washer_dryer_hookups + dish_washer + air_conditioning  + pets_mod + 
              dog_breed_restrictions + application_fee + water + sewage + garbage + electricity + internet + cable+
              gas + full_bathrooms + half_bathrooms +  heat_source + elevator + disability_access + 
              ramp + pet_rent + pet_deposit + rent * washer_dryer + type * pets_mod + type * zip_mod,
              family = poisson, data = df4)
glmmod3 = step(glm_mod_3)
summary(glmmod3)
plot(glmmod3)
cookd_glm3 = cooks.distance(glmmod3)
sort(pf(cookd_glm3, 25, 817-25), decreasing=TRUE)[1:15]
vif(glmmod3)
```

## cross validation

### MSE for lm model
```{r}
data = df2
n <- nrow(data)
nfolds = 10
# create a vector that stores the mse for each fold
mses = vector(length = nfolds)
# Assign each data point to a fold, at random
set.seed(100)
fold.labels <- sample(rep(1:nfolds, length.out=n))
for (fold in 1:nfolds) {
  test.rows <- which(fold.labels == fold)
  train <- data[-test.rows,]
  test <- data[test.rows,]
  # Fit the model on the training data
  current.model <- lm(formula = log_ttr ~ rent + zip_mod + type + bedrooms + deposit + 
    washer_dryer + air_conditioning + pets_mod + application_fee + 
    garbage + electricity + gas + elevator, data=train)
  # Generate predictions on the testing data
  predictions <- exp(predict(current.model, newdata=test))
  # Get the responses on the testing data
  test.responses <- test[,"time_to_rent"]
  test.errors <- test.responses - predictions
  mses[fold] <- mean(test.errors$time_to_rent^2)
}
mean(mses)
```


### MSE for glm model
```{r}
data = df4 %>% filter(., bedrooms != 6)
n <- nrow(data)
nfolds = 10
  # Assign each data point to a fold, at random
    # see ?sample for the effect of sample(x) on a vector x
fold.labels <- sample(rep(1:nfolds, length.out=n))
mses = vector(length = nfolds)
for (fold in 1:nfolds) {
  test.rows <- which(fold.labels == fold)
  train <- data[-test.rows,]
  test <- data[test.rows,]
  # Fit the model on the training data
  current.model <- glm(formula = time_to_rent ~ rent + zip_mod + type + bedrooms + 
    deposit + parking + washer_dryer + washer_dryer_hookups + 
    dish_washer + air_conditioning + pets_mod + dog_breed_restrictions + 
    application_fee + water + sewage + garbage + electricity + 
    internet + cable + gas + half_bathrooms + heat_source + elevator + 
    disability_access + ramp + pet_rent + pet_deposit + type:pets_mod + 
    zip_mod:type, family = poisson, data=train)
  # Generate predictions on the testing data
  predictions <- predict(current.model, newdata=test)
  # Get the responses on the testing data
  test.responses <- test[,"time_to_rent"]
  test.errors <- test.responses - predictions
  mses[fold] <- mean(test.errors$time_to_rent^2)
}
mean(mses)
```


##  K-means clustering of lat and log, variables before selection and data
```{r}
library(flexclust)
df = properties_ttr_table %>% filter(longitude >- 120 & latitude < 41)

set.seed(20)
properties_cluster <- kmeans(df[, c("latitude","longitude")], 20, nstart = 20)
properties_cluster$cluster <- as.factor(properties_cluster$cluster)
saveRDS(properties_cluster$centers,file = "data/cluster_centers.rds")
df$cluster = properties_cluster$cluster
ggplot(df, aes(longitude, latitude, col = cluster)) + geom_point()

df3 <- df %>%
  mutate(log_ttr = log(time_to_rent)) %>%
  select(., zip, cluster, time_to_rent,log_ttr,rent,type,bedrooms, deposit, parking, washer_dryer, washer_dryer_hookups, dish_washer, air_conditioning, pet_deposit, pet_rent, section_8, pets, dog_breed_restrictions, application_fee, water, sewage, garbage, electricity, gas, full_bathrooms, half_bathrooms, heat_source, elevator, pets_mod, pet_rent,pet_deposit, longitude,latitude)  %>%  na.omit() %>% filter(., bedrooms!=6 & type!="Condo")
```

## Interaction plots
```{r}
interaction.plot(df3$type, df3$pets_mod, df3$time_to_rent)
interaction.plot(df3$rent, df3$washer_dryer, df3$time_to_rent)
```

## lm with clustering
```{r,fig.height=6, fig.width=10}
# pittsburgh_coord <- c(bottom = min(df$latitude), left = min(df$longitude),
#                    top = max(df$latitude), right = max(df$longitude))

pittsburgh_coord <- c(bottom = 40.3, left = -80.3,
                   top = 40.6, right = -79.7)

map_base <- get_stamenmap(pittsburgh_coord, maptype = "toner-lite", zoom = 12)
map_object <- ggmap(map_base, extent = "device")
map_object + geom_point(aes(x = longitude, 
                            y = latitude, 
                            color = cluster), 
                            data = df3)


map_object + geom_point(aes(x = longitude,
                            y = latitude,
                            color = cluster),
                            data = df3 %>% filter(., cluster %in% c(1,8,11,18,20))) + 
  scale_color_discrete(name = "Neighborhood", labels = c("North Oakland & Squirrel Hill", "Munhall",
                                                        "Stanton Heights", "Lawrenceville and Strip", "North Shore"))

fullm3 <-lm(log_ttr ~ cluster + rent  + type + bedrooms + deposit + parking + washer_dryer +
              washer_dryer_hookups + dish_washer + air_conditioning  + pets_mod + 
              dog_breed_restrictions + application_fee + water + sewage + garbage + electricity +
              gas + full_bathrooms + half_bathrooms +  heat_source + elevator + 
              pet_rent + pet_deposit  + rent * washer_dryer + type * pets_mod,
              data = df3)
finalmod3 = step(fullm3, direction="both")

saveRDS(finalmod3, file = "data/time_to_rent_model.rds")
summary(finalmod3)
lmcoefficient2 <- as.data.frame(summary(finalmod3)$coefficients[,c(1,4)])
lmcoefficient2$multiplication_factor = exp(lmcoefficient2$Estimate)
vif(finalmod3)
plot(finalmod3)
```


## MSE for lm model after clustering
```{r}
data = df3
n <- nrow(data)
nfolds = 10
# create a vector that stores the mse for each fold
mses = vector(length = nfolds)
# Assign each data point to a fold, at random
set.seed(150)
fold.labels <- sample(rep(1:nfolds, length.out=n))
for (fold in 1:nfolds) {
  test.rows <- which(fold.labels == fold)
  train <- data[-test.rows,]
  test <- data[test.rows,]
  # Fit the model on the training data
  current.model <- lm(log_ttr ~ cluster + rent + type + deposit + washer_dryer + 
    pets_mod + application_fee + garbage + electricity + gas + 
    elevator, data=train)
  # Generate predictions on the testing data
  predictions <- exp(predict(current.model, newdata=test))
  # Get the responses on the testing data
  test.responses <- test[,"time_to_rent"]
  test.errors <- test.responses - predictions
  mses[fold] <- mean(test.errors$time_to_rent^2)
}
mean(mses)
```
